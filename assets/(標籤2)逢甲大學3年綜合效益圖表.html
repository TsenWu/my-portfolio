<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逢甲大學 LED 節能成效統計儀表板</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            /* 參照環境部背景色 */
            background-color: #f4f7f9;
        }
        /* 主容器風格：圓角、大陰影、白色背景 */
        .main-container-style {
            background-color: white;
            border-radius: 12px;
            /* 使用更明顯的陰影 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); 
            padding: 24px;
        }
        /* KPI 卡片風格：厚頂邊、柔和背景 */
        .kpi-card-style {
            border-radius: 8px;
            /* 使用較少的 padding */
            padding: 16px; 
            /* 輕微陰影，增加立體感 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); 
            height: 100%;
        }
        .chart-container {
            /* 統一縮短圖表高度以符合緊湊需求 (340px) */
            height: 340px; 
            width: 100%;
        }
        /* 針對 chart.js 調整 x 軸標籤間距 */
        .chart-label-adjustment .chartjs-render-monitor {
            padding-bottom: 0 !important;
        }
    </style>
    <!-- 載入 Chart.js 圖表函式庫 (使用穩定版本 3.7.1) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <!-- 註冊 Chart.js Annotation Plugin (用於在圖表上繪製文字) -->
    <script>
        const annotationPlugin = {
            id: 'customAnnotation',
            afterDraw(chart) {
                // 確保插件只在啟用 annotation 且設定了 text 屬性時執行
                if (chart.config.options.plugins.annotation && chart.config.options.plugins.annotation.text) {
                    const ctx = chart.ctx;
                    const annotation = chart.config.options.plugins.annotation;
                    
                    const lastIndex = chart.data.labels.length - 1;
                    
                    const meta = chart.getDatasetMeta(0);
                    const lastPoint = meta.data[lastIndex];
                    if (!lastPoint) return;

                    // 修正：改為顯示在線段下方
                    const x = lastPoint.x;
                    const y = lastPoint.y;

                    ctx.save();
                    // 文字右對齊
                    ctx.textAlign = 'right';
                    // 修正：基準線設為 top，讓文字從點的下方開始繪製
                    ctx.textBaseline = 'top';
                    ctx.fillStyle = annotation.color || '#000';
                    ctx.font = annotation.font || 'bold 13px "Noto Sans TC", "Inter", sans-serif'; // 統一字體大小
                    
                    const text = annotation.text || '';
                    
                    // 修正：y + 10 確保文字在點的下方，向下偏移 10 像素
                    ctx.fillText(text, x + 10, y + 10);
                    ctx.restore();
                }
            }
        };
        Chart.register(annotationPlugin);
    </script>
</head>
<body class="p-4 sm:p-6"> <!-- 減少 body padding 讓頁面更緊湊 -->

    <!-- 關鍵修正：確保版面寬度寬闊，使用 max-w-7xl 讓內容居中並佔據大部分螢幕空間 -->
    <div class="max-w-7xl mx-auto space-y-4"> 

        <!-- 儀表板外框 (整體卡片風格) -->
        <div class="main-container-style">
            
            <!-- 標題與橫線區塊 -->
            <header class="text-center mb-4"> <!-- 減少 mb -->
                <!-- 修正: 統一標題大小為 text-2xl -->
                <h1 class="text-2xl font-extrabold text-gray-900 mb-2 border-b-4 border-gray-300 pb-2 text-center">
                    逢甲大學 LED 節能成效儀表板 — 累積效益
                </h1>
                <!-- 副標題區塊 -->
                <p class="text-lg text-gray-600 mt-2">
                    換裝數量：13,020 盞 (光板燈/平板燈/支架燈) | 數據統計期間：111-113 年度 (3年) 持續量測中
                </p>
            </header>

            <!-- 關鍵財務、環保與性能效益 (四欄 KPI 卡片區) -->
            <!-- 修正: 調整為 md:grid-cols-4 佈局，納入可靠度卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> <!-- 減少 mb -->
                
                <!-- 成果 1: 省下電費 (綠色) -->
                <div class="kpi-card-style bg-green-50 border-t-4 border-green-600">
                    <p class="text-sm font-medium text-gray-500 mb-1 uppercase tracking-wider">三年節省電費總額</p>
                    <div class="flex items-baseline space-x-0.5"> <!-- 數字與單位緊密相連 -->
                        <!-- 修正: 數字縮小至 text-3xl -->
                        <span class="text-3xl font-extrabold text-green-700">1,300</span>
                        <span class="text-lg font-bold text-green-700">萬 NTD</span>
                    </div>
                </div>

                <!-- 成果 2: 節約碳排 (藍色) -->
                <div class="kpi-card-style bg-blue-50 border-t-4 border-blue-600">
                    <p class="text-sm font-medium text-gray-500 mb-1 uppercase tracking-wider">三年節約碳排放總量</p>
                    <div class="flex items-baseline space-x-0.5"> <!-- 數字與單位緊密相連 -->
                         <!-- 修正: 數字縮小至 text-3xl -->
                        <span class="text-3xl font-extrabold text-blue-700">1,755</span>
                        <span class="text-lg font-bold text-blue-700">噸 CO₂e</span>
                    </div>
                </div>

                <!-- 成果 3: 可靠度表現 (新增 - 紅色) -->
                <div class="kpi-card-style bg-red-50 border-t-4 border-red-600">
                    <p class="text-sm font-semibold text-gray-500 mb-1 uppercase tracking-wider">可靠度表現 (111-113)</p>
                    <div class="flex items-baseline space-x-0.5"> 
                         <!-- 修正: 數字縮小至 text-3xl -->
                        <span class="text-3xl font-extrabold text-red-700">0</span>
                        <span class="text-lg font-bold text-red-700">% 故障率</span>
                    </div>
                </div>

                <!-- 成果 4: 節能率 (黃色) -->
                <div class="kpi-card-style bg-yellow-50 border-t-4 border-yellow-600">
                    <p class="text-sm font-semibold text-gray-500 mb-1 uppercase tracking-wider">整體節能率</p>
                    <div class="flex items-baseline space-x-0.5"> <!-- 數字與單位緊密相連 -->
                         <!-- 修正: 數字縮小至 text-3xl -->
                         <!-- 修正: 數值更正為 67 -->
                        <span class="text-3xl font-extrabold text-yellow-700">67</span>
                        <span class="text-lg font-bold text-yellow-700">%</span>
                    </div>
                </div>
            </div>

            <!-- 圖表區塊 (兩欄佈局，高度緊湊) -->
            <h2 class="text-xl font-bold text-gray-700 mb-3 text-center"> <!-- 統一標題樣式 -->
                年度節能累積趨勢分析
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

                <!-- 圖表 1: 累積節省耗電量趨勢 -->
                <div class="p-4 rounded-lg border border-gray-200 chart-label-adjustment"> 
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">
                        累積節省耗電量總趨勢 (kWh)
                    </h2>
                    <div class="chart-container">
                        <canvas id="cumulativeSavingChart"></canvas>
                    </div>
                </div>

                <!-- 圖表 2: 累積節約碳排放量總趨勢 -->
                <div class="p-4 rounded-lg border border-gray-200 chart-label-adjustment"> 
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">
                        累積節約碳排放量總趨勢 (噸 CO₂e)
                    </h2>
                    <div class="chart-container">
                        <canvas id="totalSavingChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 額外效益總結 (緊湊於底部) -->
            <div class="mt-4 p-4 rounded-lg border border-gray-200 text-sm"> <!-- 減少 mt, 移除 bg-gray-50 -->
                <h3 class="font-bold text-base mb-1 text-gray-700">
                    綠色永續發展成果摘要
                </h3>
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-1 sm:space-y-0 text-gray-600">
                    <p>
                        <span class="font-bold text-indigo-600">每年縮減：</span>
                        <span class="font-extrabold text-indigo-600">↓ 593,213 度</span> (年用電度數平均)
                    </p>
                    <p>
                        <span class="font-bold text-indigo-600">環保比喻：</span>
                        <span class="font-extrabold text-indigo-600">14 萬棵樹</span> (相當於吸收的碳排放量)
                    </p>
                    <p>
                        <span class="font-bold text-indigo-600">安裝總數：</span>
                        <span class="font-bold text-green-600">13,020 盞</span>
                    </p>
                </div>
            </div>

            <!-- 頁面底部間距 -->
            <div class="h-4"></div>

        </div>

    </div>

    <script>
        // 數據來源
        const annualData = {
            labels: ['111 年度', '112 年度', '113 年度'],
            savings: [1173978, 1161828, 1159009] // 年節省電量 (kWh)
        };
        
        // 計算累積節省電量
        const cumulativeSavings = [
            annualData.savings[0],
            annualData.savings[0] + annualData.savings[1],
            annualData.savings[0] + annualData.savings[1] + annualData.savings[2]
        ];

        const totalSavedKWh = Math.round(cumulativeSavings[cumulativeSavings.length - 1]); // 3,494,815 kWh

        // 碳排放數據計算 (基於 3,494,815 kWh 總節省量對應 1,755 噸碳排的比例)
        const carbonFactor = 1755 / totalSavedKWh; 
        const annualCarbonReduction = annualData.savings.map(kWh => kWh * carbonFactor);
        
        // 計算累積節約碳排放量
        const cumulativeCarbon = [
            annualCarbonReduction[0],
            annualCarbonReduction[0] + annualCarbonReduction[1],
            annualCarbonReduction[0] + annualCarbonReduction[1] + annualCarbonReduction[2]
        ];
        const totalCarbonTons = cumulativeCarbon[cumulativeCarbon.length - 1].toFixed(1); // 1755.0 噸
        
        // 1. 累積節省耗電量趨勢 (Area Chart / 線圖)
        function renderCumulativeSavingChart() {
            const chartCanvas = document.getElementById('cumulativeSavingChart');
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: annualData.labels,
                    datasets: [{
                        label: '累積節省耗電量 (kWh)',
                        data: cumulativeSavings,
                        // 使用柔和綠色
                        backgroundColor: 'rgba(52, 211, 153, 0.4)', /* Light Emerald */
                        borderColor: 'rgba(16, 185, 129, 1)',
                        pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                        pointBorderColor: '#fff',
                        tension: 0.4, 
                        fill: true,
                        pointRadius: 5, // 統一縮小點的大小
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // 格式化數字，加上逗號
                                    return '累積節省: ' + Math.round(context.parsed.y).toLocaleString('en-US') + ' kWh';
                                }
                            }
                        },
                        // 新增 Annotation 配置
                        annotation: {
                            text: `累積節省 ${totalSavedKWh.toLocaleString('en-US')} 度電`,
                            color: 'rgba(16, 185, 129, 1)', // 綠色
                            font: 'bold 13px "Noto Sans TC", "Inter", sans-serif' // 統一字體大小
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '累積節省量 (kWh)', font: { size: 12 } }, // 統一縮小標題字體
                            ticks: {
                                callback: function(value) {
                                    // 簡化顯示，例如 1M, 2M
                                    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return (value / 1000).toFixed(0) + 'k';
                                    return value;
                                },
                                font: { size: 11 } // 統一縮小刻度字體
                            }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: {
                                padding: 2, 
                                font: { size: 11 } // 統一縮小刻度字體
                            }
                        }
                    }
                }
            });
        }

        // 2. 累積節約碳排放量總趨勢 (線圖)
        function renderCumulativeCarbonChart() {
            const chartCanvas = document.getElementById('totalSavingChart');
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');

            new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: annualData.labels,
                    datasets: [{
                        label: '累積節約碳排放量 (噸 CO₂e)',
                        data: cumulativeCarbon,
                        // 使用柔和藍色
                        backgroundColor: 'rgba(96, 165, 250, 0.4)', /* Light Blue */
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        tension: 0.4, 
                        fill: true,
                        pointRadius: 5, // 統一縮小點的大小
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // 顯示累積數值，四捨五入到小數點第一位
                                    return '累積減碳: ' + context.parsed.y.toFixed(1).toLocaleString('en-US') + ' 噸';
                                }
                            }
                        },
                        // 新增 Annotation 配置
                        annotation: {
                            text: `累積減碳 ${totalCarbonTons} 噸`,
                            color: 'rgba(59, 130, 246, 1)', // 藍色
                            font: 'bold 13px "Noto Sans TC", "Inter", sans-serif' // 統一字體大小
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '累積減碳量 (噸)', font: { size: 12 } }, // 統一縮小標題字體
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('en-US');
                                },
                                font: { size: 11 } // 統一縮小刻度字體
                            }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: {
                                padding: 2, 
                                font: { size: 11 } // 統一縮小刻度字體
                            }
                        }
                    }
                }
            });
        }

        // 渲染所有圖表
        window.onload = function () {
            renderCumulativeSavingChart();
            renderCumulativeCarbonChart();
        };
    </script>

</body>

</html>
